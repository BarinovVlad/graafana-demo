$ErrorActionPreference = "Stop"

# === Настройки Grafana ===
$GrafanaURL = "http://localhost:3000"
$ApiToken = "${{ secrets.GRAFANA_API_TOKEN }}"

$baseFolder = "./dashboards/hostA"
$libraryPanelsDir = "./provisioning/library_panels"

Write-Host "`n===== Deploying to Grafana at $GrafanaURL ====="

# === Удаляем все существующие library panels ===
try {
    $existingPanels = Invoke-RestMethod -Uri "$GrafanaURL/api/library-elements" -Headers @{
        Authorization = "Bearer $ApiToken"
    }

    if ($existingPanels.elements) {
        foreach ($panel in $existingPanels.elements) {
            Invoke-RestMethod -Uri "$GrafanaURL/api/library-elements/$($panel.uid)" -Method Delete -Headers @{
                Authorization = "Bearer $ApiToken"
            }
            Write-Host "Deleted existing panel by UID: $($panel.uid)"
        }
    } else {
        Write-Host "No existing library panels to delete."
    }
} catch {
    Write-Host "Failed to fetch existing library panels, continuing..."
}

# === Загружаем новые library panels ===
if (Test-Path $libraryPanelsDir) {
    Write-Host "`nDeploying library panels from $libraryPanelsDir"
    Get-ChildItem -Path $libraryPanelsDir -Filter "*.json" | ForEach-Object {
        $panel = Get-Content $_.FullName -Raw | ConvertFrom-Json

        if (-not $panel.uid) {
            Write-Host "Skipping panel with missing UID: $($_.Name)"
            return
        }

        # Удаляем id и version, чтобы избежать конфликтов
        if ($panel.PSObject.Properties.Name -contains 'id') { $panel.PSObject.Properties.Remove('id') }
        if ($panel.PSObject.Properties.Name -contains 'version') { $panel.PSObject.Properties.Remove('version') }

        $uploadPayload = $panel | ConvertTo-Json -Depth 20

        # Создаем новую панель
        Invoke-RestMethod -Uri "$GrafanaURL/api/library-elements" -Method Post -Headers @{
            Authorization = "Bearer $ApiToken"
            "Content-Type"  = "application/json"
        } -Body $uploadPayload

        Write-Host "✅ Deployed library panel: $($panel.uid)"
    }
} else {
    Write-Host "Library panels folder not found: $libraryPanelsDir"
}

# === Деплой dashboards ===
$gitFolders = Get-ChildItem -Path $baseFolder -Directory -ErrorAction SilentlyContinue
if (-not $gitFolders) {
    Write-Host "No folders found in $baseFolder"
} else {
    foreach ($folder in $gitFolders) {
        $clientName = $folder.Name
        $folderUid = $clientName.ToLower()
        $clientPath = $folder.FullName

        Write-Host "`n=== Processing client: $clientName ==="

        # Создаем папку в Grafana, если не существует
        try {
            $updatedFolder = Invoke-RestMethod -Uri "$GrafanaURL/api/folders/$folderUid" -Headers @{
                Authorization = "Bearer $ApiToken"
            }
            Write-Host "Folder '$folderUid' exists in Grafana."
        } catch {
            Write-Host "Creating folder '$folderUid'..."
            $payload = @{ uid = $folderUid; title = $clientName } | ConvertTo-Json -Compress
            $updatedFolder = Invoke-RestMethod -Uri "$GrafanaURL/api/folders" -Method Post -Headers @{
                Authorization = "Bearer $ApiToken"
                "Content-Type" = "application/json"
            } -Body $payload
        }

        # Загружаем dashboards
        $localUids = @()
        Get-ChildItem -Path $clientPath -Filter "*.json" | ForEach-Object {
            $json = Get-Content $_.FullName -Raw
            $dashboard = $json | ConvertFrom-Json

            if (-not $dashboard.uid) {
