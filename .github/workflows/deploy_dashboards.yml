name: Deploy Grafana Dashboards

on:
  push:
    paths:
      - 'dashboards/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy dashboards to Grafana with cleanup
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $GrafanaURL = "http://localhost:3000"
          $ApiToken = "${{ secrets.GRAFANA_API_TOKEN }}"
          $FolderUID = "auto-folder"

          
          try {
            Invoke-RestMethod -Uri "$GrafanaURL/api/folders/$FolderUID" -Headers @{
              Authorization = "Bearer $ApiToken"
              "Content-Type" = "application/json"
            } -Method Get -ErrorAction Stop
            Write-Host "Folder '$FolderUID' already exists, skipping creation."
          }
          catch {
            Write-Host "Folder '$FolderUID' not found, creating..."
            $folderPayload = @{ uid = $FolderUID; title = "CI Dashboards" } | ConvertTo-Json -Compress
            Invoke-RestMethod -Uri "$GrafanaURL/api/folders" -Method Post -Headers @{
              Authorization = "Bearer $ApiToken"
              "Content-Type" = "application/json"
            } -Body $folderPayload -ErrorAction Stop
          }

          
          $localDashboards = @()
          Get-ChildItem -Path ".\dashboards" -Filter "*.json" | ForEach-Object {
            $json = Get-Content $_.FullName -Raw
            $dashboard = $json | ConvertFrom-Json

            if (-not $dashboard.uid) {
              Write-Error "Dashboard file $($_.Name) has no uid! Add a unique uid field."
              exit 1
            }

            $localDashboards += $dashboard.uid

            $payload = @{
              dashboard = $dashboard
              folderUid = $FolderUID
              overwrite = $true
            } | ConvertTo-Json -Depth 10

            Write-Host "Uploading $($_.Name)..."
            Invoke-RestMethod -Uri "$GrafanaURL/api/dashboards/db" -Method Post -Headers @{
              Authorization = "Bearer $ApiToken"
              "Content-Type" = "application/json"
            } -Body $payload
          }

          
          $folder = Invoke-RestMethod -Uri "$GrafanaURL/api/folders/$FolderUID" -Headers @{
            Authorization = "Bearer $ApiToken"
          }

          
          $grafanaDashboards = Invoke-RestMethod -Uri "$GrafanaURL/api/search?folderIds=$($folder.id)" -Headers @{
            Authorization = "Bearer $ApiToken"
          }

        
          Write-Host "=== Local dashboard UIDs ==="
          $localDashboards | ForEach-Object { Write-Host " - $_" }

          Write-Host "=== Dashboards in Grafana ==="
          $grafanaDashboards | ForEach-Object { Write-Host " - $($_.uid)" }

         
          $toDelete = $grafanaDashboards | Where-Object { $localDashboards -notcontains $_.uid }

          Write-Host "=== Dashboards to delete ==="
          $toDelete | ForEach-Object { Write-Host " - $($_.uid)" }

          foreach ($dash in $toDelete) {
            Write-Host "Deleting dashboard $($dash.title) with uid $($dash.uid)..."
            Invoke-RestMethod -Uri "$GrafanaURL/api/dashboards/uid/$($dash.uid)" -Method Delete -Headers @{
              Authorization = "Bearer $ApiToken"
            }
          }
