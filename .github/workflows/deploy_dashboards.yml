name: Deploy Grafana Dashboards and Library Panels

on:
  push:
    paths:
      - 'dashboards/**'
      - 'provisioning/library_panels/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy dashboards and library panels
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          # Grafana targets
          $grafanaTargets = @(
            @{ Folder = "hostA"; Url = "http://localhost:3000"; Token = "${{ secrets.GRAFANA_API_TOKEN }}" },
            @{ Folder = "hostB"; Url = "http://localhost:3001"; Token = "${{ secrets.GRAFANA_API_TOKENV_2 }}" }
          )

          foreach ($target in $grafanaTargets) {
            $GrafanaURL = $target.Url
            $ApiToken = $target.Token

            Write-Host "===== Deploying to Grafana at $GrafanaURL ====="

            # --- Library Panels ---
            $libraryPanelsDir = "./provisioning/library_panels"
            if (Test-Path $libraryPanelsDir) {
              Write-Host "Deploying library panels from $libraryPanelsDir"

              Get-ChildItem -Path $libraryPanelsDir -Filter "*.json" | ForEach-Object {
                $panel = Get-Content $_.FullName -Raw | ConvertFrom-Json

                if (-not $panel.uid) {
                  Write-Host "Skipping panel with missing UID"
                  return
                }

                # --- Delete by UID if exists ---
                try {
                  Invoke-RestMethod -Uri "$GrafanaURL/api/library-elements/$($panel.uid)" -Method Delete -Headers @{
                    Authorization = "Bearer $ApiToken"
                  }
                  Write-Host "Deleted existing panel by UID: $($panel.uid)"
                } catch {
                  Write-Host "Panel $($panel.uid) not found by UID, continuing..."
                }

                # --- Delete by name if exists (catch duplicate name conflicts) ---
                try {
                  $allPanels = Invoke-RestMethod -Uri "$GrafanaURL/api/library-elements" -Headers @{
                    Authorization = "Bearer $ApiToken"
                  }
                  $conflict = $allPanels | Where-Object { $_.name -eq $panel.name }
                  if ($conflict) {
                    Invoke-RestMethod -Uri "$GrafanaURL/api/library-elements/$($conflict.uid)" -Method Delete -Headers @{
                      Authorization = "Bearer $ApiToken"
                    }
                    Write-Host "Deleted existing panel by name: $($panel.name)"
                  }
                } catch {
                  Write-Host "No name conflict for panel $($panel.name)"
                }

                # --- Generate new UID to avoid any conflicts ---
                $newUID = [guid]::NewGuid().ToString("N")
                $panel.uid = $newUID

                # Remove id/version if exist
                if ($panel.PSObject.Properties.Name -contains 'id') { $panel.PSObject.Properties.Remove('id') }
                if ($panel.PSObject.Properties.Name -contains 'version') { $panel.PSObject.Properties.Remove('version') }

                # --- Create panel ---
                $payload = $panel | ConvertTo-Json -Depth 20
                Invoke-RestMethod -Uri "$GrafanaURL/api/library-elements" -Method Post -Headers @{
                  Authorization = "Bearer $ApiToken"
                  "Content-Type" = "application/json"
                } -Body $payload
                Write-Host "✅ Deployed library panel: $($panel.name) with UID: $newUID"
              }
            } else {
              Write-Host "No library panels folder found at $libraryPanelsDir"
            }

            # --- Dashboards (обычный процесс, как у тебя было) ---
            $baseFolder = "./dashboards/$($target.Folder)"
            $gitFolders = Get-ChildItem -Path $baseFolder -Directory -ErrorAction SilentlyContinue
            if ($gitFolders) {
              $gitFolderNames = $gitFolders.Name.ToLower()
              $grafanaFolders = Invoke-RestMethod -Uri "$GrafanaURL/api/folders" -Headers @{
                Authorization = "Bearer $ApiToken"
              }

              foreach ($folder in $gitFolders) {
                $folderUid = $folder.Name.ToLower()
                $clientPath = $folder.FullName

                # Создание/проверка папки
                try {
                  $updatedFolder = Invoke-RestMethod -Uri "$GrafanaURL/api/folders/$folderUid" -Headers @{
                    Authorization = "Bearer $ApiToken"
                  }
                } catch {
                  $payload = @{ uid = $folderUid; title = $folder.Name } | ConvertTo-Json -Compress
                  $updatedFolder = Invoke-RestMethod -Uri "$GrafanaURL/api/folders" -Method Post -Headers @{
                    Authorization = "Bearer $ApiToken"
                    "Content-Type" = "application/json"
                  } -Body $payload
                }

                # Загрузка dashboard
                Get-ChildItem -Path $clientPath -Filter "*.json" | ForEach-Object {
                  $dashboard = Get-Content $_.FullName -Raw | ConvertFrom-Json
                  if ($dashboard.PSObject.Properties.Name -contains 'id') { $dashboard.PSObject.Properties.Remove('id') }
                  if ($dashboard.PSObject.Properties.Name -contains 'version') { $dashboard.PSObject.Properties.Remove('version') }

                  $payload = @{ dashboard = $dashboard; folderUid = $folderUid; overwrite = $true } | ConvertTo-Json -Depth 10
                  Invoke-RestMethod -Uri "$GrafanaURL/api/dashboards/db" -Method Post -Headers @{
                    Authorization = "Bearer $ApiToken"
                    "Content-Type" = "application/json"
                  } -Body $payload
                  Write-Host "Uploaded dashboard: $($_.Name)"
                }
              }
            }
          }


