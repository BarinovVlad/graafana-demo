name: Deploy Grafana Dashboards

on:
  push:
    paths:
      - 'dashboards/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload dashboards to Grafana
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $GrafanaURL = "http://localhost:3000"
          $ApiToken = "${{ secrets.GRAFANA_API_TOKEN }}"
          $FolderUID = "auto-folder"

          $folderPayload = @{
            uid = $FolderUID
            title = "CI Dashboards"
          } | ConvertTo-Json -Compress

          Invoke-RestMethod -Uri "$GrafanaURL/api/folders" -Method Post -Headers @{
            Authorization = "Bearer $ApiToken"
            "Content-Type" = "application/json"
          } -Body $folderPayload -ErrorAction SilentlyContinue

          Get-ChildItem -Path ".\dashboards" -Filter "*.json" | ForEach-Object {
            $json = Get-Content $_.FullName -Raw
            $dashboard = $json | ConvertFrom-Json
            $dashboard.uid = $dashboard.uid
            $payload = @{
              dashboard = $dashboard
              folderUid = $FolderUID
              overwrite = $true
            } | ConvertTo-Json -Depth 10

            Write-Host "Uploading $($_.Name)..."

            Invoke-RestMethod -Uri "$GrafanaURL/api/dashboards/db" -Method Post -Headers @{
              Authorization = "Bearer $ApiToken"
              "Content-Type" = "application/json"
            } -Body $payload
          }

